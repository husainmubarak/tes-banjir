<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring Banjir</title>
    <!-- Tailwind CSS untuk Styling Cepat -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Animasi Ombak Air */
        .water-container {
            position: relative;
            height: 200px;
            width: 200px;
            background: #e0f2fe;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .water {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%; /* Akan diubah via JS */
            background: #3b82f6;
            transition: height 0.5s ease-in-out, background-color 0.5s;
        }
        .water::before, .water::after {
            content: "";
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: 50%;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 40%;
            animation: wave 5s linear infinite;
        }
        .water::after {
            border-radius: 35%;
            background: rgba(255, 255, 255, 0.2);
            animation: wave 5s linear infinite; 
            animation-duration: 7s;
        }
        @keyframes wave {
            0% { transform: translate(-50%, 0) rotate(0deg); }
            100% { transform: translate(-50%, 0) rotate(360deg); }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-800 to-slate-900 min-h-screen text-slate-800 font-sans p-4">

    <!-- Header -->
    <div class="max-w-5xl mx-auto mb-8 text-center pt-6">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
            <i class="fas fa-satellite-dish mr-2"></i>Flood Warning System
        </h1>
        <p class="text-slate-300">Monitoring Level Air Sungai Real-time</p>
    </div>

    <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- KOLOM 1: STATUS VISUAL -->
        <div class="glass-card rounded-2xl p-6 shadow-xl text-center md:col-span-1">
            <h2 class="text-xl font-bold mb-6 text-slate-600">Visualisasi Level</h2>
            
            <div class="water-container mb-6">
                <div class="water" id="waterLevel"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span id="textJarak" class="text-3xl font-bold text-slate-700 z-10 mix-blend-multiply">0 cm</span>
                </div>
            </div>

            <div class="mt-4 p-4 rounded-xl transition-all duration-300" id="statusBox">
                <div class="text-xs uppercase tracking-widest font-bold opacity-70">Status</div>
                <div class="text-2xl font-black" id="textStatus">MENUNGGU DATA...</div>
            </div>
        </div>

        <!-- KOLOM 2: DATA SENSOR & SIRINE -->
        <div class="glass-card rounded-2xl p-6 shadow-xl md:col-span-2 flex flex-col justify-between">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Sensor Kontak -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 flex items-center gap-4">
                    <div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                        <i class="fas fa-water text-xl"></i>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">Sensor Kontak</div>
                        <div class="font-bold text-lg" id="kontakStatus">Kering</div>
                    </div>
                </div>
                <!-- Status Sirine -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 flex items-center gap-4">
                    <div class="h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 transition-colors" id="sirenIconBg">
                        <i class="fas fa-bullhorn text-xl" id="sirenIcon"></i>
                    </div>
                    <div>
                        <div class="text-xs text-slate-500">Status Sirine</div>
                        <div class="font-bold text-lg" id="sirenText">Mati</div>
                    </div>
                </div>
            </div>

            <!-- Grafik -->
            <div class="flex-grow bg-white rounded-xl p-2 border border-slate-100">
                <canvas id="floodChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Update: Menggunakan io() kosong agar otomatis mendeteksi host (VPS atau Local)
        const socket = io(); 
        
        // Setup Grafik Chart.js
        const ctx = document.getElementById('floodChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Ketinggian Air (cm)',
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    data: [],
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });

        // MENERIMA DATA DARI BACKEND
        socket.on("sensor_update", (data) => {
            console.log("Data diterima:", data);
            updateDashboard(data);
        });

        function updateDashboard(data) {
            const { kedalaman, kontak, status, waktu } = data;
            
            // 1. Update Teks Jarak
            document.getElementById('textJarak').innerText = kedalaman + " cm";

            // 2. Update Animasi Air (Asumsi Sungai max 300cm)
            const maxDepth = 300; 
            let percentage = (kedalaman / maxDepth) * 100;
            if(percentage > 100) percentage = 100;
            document.getElementById('waterLevel').style.height = percentage + "%";

            // 3. Update Status Box & Warna
            const statusBox = document.getElementById('statusBox');
            const textStatus = document.getElementById('textStatus');
            const waterDiv = document.getElementById('waterLevel');

            textStatus.innerText = status;

            if (status === 'BAHAYA') {
                statusBox.className = "mt-4 p-4 rounded-xl bg-red-100 text-red-800 animate-pulse";
                waterDiv.style.backgroundColor = "#ef4444"; // Merah
                
                // Update Sirine UI
                document.getElementById('sirenIconBg').className = "h-12 w-12 rounded-full bg-red-500 text-white flex items-center justify-center animate-bounce";
                document.getElementById('sirenText').innerText = "MENYALA ðŸ”Š";
                document.getElementById('sirenText').className = "font-bold text-lg text-red-600";
            } else if (status === 'WASPADA') {
                statusBox.className = "mt-4 p-4 rounded-xl bg-orange-100 text-orange-800";
                waterDiv.style.backgroundColor = "#f97316"; // Oranye
                
                // Sirine Mati
                resetSirenUI();
            } else {
                statusBox.className = "mt-4 p-4 rounded-xl bg-green-100 text-green-800";
                waterDiv.style.backgroundColor = "#3b82f6"; // Biru
                
                // Sirine Mati
                resetSirenUI();
            }

            // 4. Update Status Sensor Kontak
            const kontakElem = document.getElementById('kontakStatus');
            if(kontak == 1) {
                kontakElem.innerText = "TERENDAM!";
                kontakElem.className = "font-bold text-lg text-red-600";
            } else {
                kontakElem.innerText = "Kering";
                kontakElem.className = "font-bold text-lg text-slate-700";
            }

            // 5. Update Grafik
            if (chart.data.labels.length > 15) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(waktu);
            chart.data.datasets[0].data.push(kedalaman);
            chart.update();
        }

        function resetSirenUI() {
            document.getElementById('sirenIconBg').className = "h-12 w-12 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center";
            document.getElementById('sirenText').innerText = "Mati";
            document.getElementById('sirenText').className = "font-bold text-lg text-slate-700";
        }
    </script>
</body>
</html>